<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Scaling - utxos.org -- Bitcoin for Everyone</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon-32x32.png><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><link rel=stylesheet href=/css/style.min.001cd82c5deb4a55f69f076992dd043b44db7bc374aefabccae88643876b11a8.css></head><body class="page page-default-single"><div id=main-menu-mobile class=main-menu-mobile><ul><li class=menu-item-home><a href=/><span>Home</span></a></li><li class="menu-item-bip-119 materials dropdown show"><a class=dropdown-toggle href=# role=button id=dropdownMenuLink data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>BIP-119 Materials</span></a><div class=dropdown-menu aria-labelledby=dropdownMenuLink><div class=dropdown-item><a href=https://github.com/bitcoin/bips/blob/master/bip-0119.mediawiki style=color:#000>Specification</a></div><div class=dropdown-item><a href=https://github.com/bitcoin/bitcoin/pull/21702 style=color:#000>Core Pull Request</a></div><div class=dropdown-item><a href=/deployment/ style=color:#000>Deployment Options</a></div><div class=dropdown-item><a href=/alternatives/ style=color:#000>Alternative Designs</a></div><div class=dropdown-item><a href=/workshops/ style=color:#000>Workshops</a></div></div></li><li class="menu-item-applications dropdown show"><a class=dropdown-toggle href=# role=button id=dropdownMenuLink data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Applications</span></a><div class=dropdown-menu aria-labelledby=dropdownMenuLink><div class=dropdown-item><a href=/uses/ style=color:#000>Use Cases</a></div><div class=dropdown-item><a href=/analysis/ style=color:#000>Ecosystem Impact</a></div><div class=dropdown-item><a href=https://learn.sapio-lang.org style=color:#000>Sapio</a></div></div></li><li class=menu-item-signals><a href=/signals/><span>Signals</span></a></li><li class="menu-item-more resources"><a href=/resources/><span>More Resources</span></a></li><li class=menu-item-sponsors><a href=/sponsors/><span>Sponsors</span></a></li><li class=menu-item-telegram><a href=https://t.me/op_ctv><span>Telegram</span></a></li></ul></div><div class=wrapper><div class=header><div class=container><div class=logo><a href=https://utxos.org><img alt=utxos.org src=/images/logo.svg></a></div><div class=logo-mobile><a href=https://utxos.org><img alt=utxos.org src=/images/logo-mobile.svg></a></div><div id=main-menu class=main-menu><ul><li class=menu-item-home><a href=/><span>Home</span></a></li><li class="dropdown show"><a class="btn dropdown-toggle" href=# role=button id=dropdownMenuLink data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>BIP-119 Materials</span></a><div class=dropdown-menu aria-labelledby=dropdownMenuLink><div class=dropdown-item><a href=https://github.com/bitcoin/bips/blob/master/bip-0119.mediawiki>Specification</a></div><div class=dropdown-item><a href=https://github.com/bitcoin/bitcoin/pull/21702>Core Pull Request</a></div><div class=dropdown-item><a href=/deployment/>Deployment Options</a></div><div class=dropdown-item><a href=/alternatives/>Alternative Designs</a></div><div class=dropdown-item><a href=/workshops/>Workshops</a></div></div></li><li class="dropdown show"><a class="btn dropdown-toggle" href=# role=button id=dropdownMenuLink data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Applications</span></a><div class=dropdown-menu aria-labelledby=dropdownMenuLink><div class=dropdown-item><a href=/uses/>Use Cases</a></div><div class=dropdown-item><a href=/analysis/>Ecosystem Impact</a></div><div class=dropdown-item><a href=https://learn.sapio-lang.org>Sapio</a></div></div></li><li class=menu-item-signals><a href=/signals/><span>Signals</span></a></li><li class="menu-item-more resources"><a href=/resources/><span>More Resources</span></a></li><li class=menu-item-sponsors><a href=/sponsors/><span>Sponsors</span></a></li><li class=menu-item-telegram><a href=https://t.me/op_ctv><span>Telegram</span></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button aria-label="Mobile Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pb-6 pt-6 pt-md-10 pb-md-10"><div class="row justify-content-start"><div class="offset-1 col-10 col-md-10"><div class="service service-single"><h1 class=title>Scaling</h1><h2 class=byline>by <a href=https://twitter.com/JeremyRubin>Jeremy Rubin</a></h2><div class=content><p><img src=/images/uses/scalepay.svg alt></p><p>When there is a high demand for blockspace it becomes very expensive to make
transactions. By using OP_CHECKTEMPLATEVERIFY, a large volume payment processor may
aggregate all their payments into a single O(1) transaction for purposes of
confirmation. Then, some time later, the payments can be expanded out of that
UTXO when the demand for blockspace is decreased.</p><p>Without OP_CHECKTEMPLATEVERIFY, this is still possible to do with Schnorr signatures
(even with ECDSA given multiparty schemes). However, it is not possible to do
non-interactively, which fundamentally limits the viability of the approach as
interacting to collect signatures from all recipients may be difficult or slow.</p><p>The sender of a congestion controlled transaction can choose from many different
transaction structures.</p><p>The simplest option is a single committed transaction which expands from 1
output to N. Even this simple use case is highly useful because the expansion
can wait till cheap block space is available.</p><p>As the number of recipients grows, a sender can commit to a tree of outputs
using OP_CHECKTEMPLATEVERIFY. The tree permits them to confirm as many payments as they
like (i.e., even more than can fit into a block). Such a technique starts to
make sense when:</p><p><code>N*size_of(Output) > log(N)*size_of(OP_CHECKTEMPLATEVERIFY Txn) + size_of(Output)</code></p><p>Assuming straightforward transaction sizes, this is around 10
recipients.</p><p>Furthermore, the script can commit to variable size expansions &ndash; say, one node
which expands by 2, by 4, by 8, etc. This allows a trade off between transaction
overhead and immediately available block space. Depending on implementation
(either at the transaction level, the script level, or via Taproot), the Merkle
tree lookup in that case is O(log(log(N))) extra overhead, but the tree can be
Huffman encoded to make it E[O(1)] depending on block demand.</p><p>Each node of the tree can also attempt to &lsquo;opt in&rsquo; to preferring a multiparty
signature based spend (using Schnorr signatures or Taproot), but if participants
are offline or malicious the expansion can proceed to smaller groups.</p><p>The overall overhead of the tree approach (without optimizations) is from the
perspective of each user O(log(N)) transactions with an expectation of just 1
additional transaction, and 2N from the perspective of the network. However,
given the lack of signatures required for such transactions, the actual overhead
is less.</p><p>Below is an example implementation of a tree payment in <a href=https://learn.sapio-lang.org>sapio</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// Copyright Judica, Inc 2021
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This Source Code Form is subject to the terms of the Mozilla Public
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  License, v. 2.0. If a copy of the MPL was not distributed with this
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  file, You can obtain one at https://mozilla.org/MPL/2.0/.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#e6db74>//! contracts for paying a large set of recipients fee efficiently
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#66d9ef>use</span> sapio::contract::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> sapio::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> schemars::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> serde::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::convert::TryInto;
</span></span><span style=display:flex><span><span style=color:#e6db74>/// instructions to send an amount of coin to an address
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[derive(JsonSchema, Serialize, Deserialize, Clone)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Payment</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// The amount of coin to send
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> amount: <span style=color:#a6e22e>bitcoin</span>::util::amount::CoinAmount,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// # Address
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#e6db74>/// The Address to send to
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> address: <span style=color:#a6e22e>bitcoin</span>::Address,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#e6db74>/// Create a tree of payments with a given radix
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#75715e>#[derive(JsonSchema, Serialize, Deserialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TreePay</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// the list of payments to create
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> participants: Vec<span style=color:#f92672>&lt;</span>Payment<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// the radix to use (4 or 5 near optimal, depending on if CTV emulation is used this may be inaccurate)
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    <span style=color:#66d9ef>pub</span> radix: <span style=color:#66d9ef>usize</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> TreePay {
</span></span><span style=display:flex><span>    then<span style=color:#f92672>!</span> {<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>expand</span>(self, ctx) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> builder <span style=color:#f92672>=</span> ctx.template();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self.participants.len() <span style=color:#f92672>&gt;</span> self.radix {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> c <span style=color:#66d9ef>in</span> self.participants.chunks(self.participants.len()<span style=color:#f92672>/</span>self.radix) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> amt <span style=color:#f92672>=</span>  bitcoin::util::amount::Amount::from_sat(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> Payment{amount, <span style=color:#f92672>..</span>}  <span style=color:#66d9ef>in</span> c {
</span></span><span style=display:flex><span>                    amt <span style=color:#f92672>+=</span> amount.clone().try_into()<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                builder <span style=color:#f92672>=</span> builder.add_output(amt, <span style=color:#f92672>&amp;</span>TreePay {participants: <span style=color:#a6e22e>c</span>.to_vec(), radix: <span style=color:#a6e22e>self</span>.radix}, None)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> Payment{amount, address} <span style=color:#66d9ef>in</span> self.participants.iter() {
</span></span><span style=display:flex><span>                builder <span style=color:#f92672>=</span> builder.add_output((<span style=color:#f92672>*</span>amount).try_into()<span style=color:#f92672>?</span>, <span style=color:#f92672>&amp;</span>Compiled::from_address(address.clone(), None), None)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        builder.into()
</span></span><span style=display:flex><span>    }}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Contract <span style=color:#66d9ef>for</span> TreePay {
</span></span><span style=display:flex><span>    declare<span style=color:#f92672>!</span> {then, Self::expand}
</span></span><span style=display:flex><span>    declare<span style=color:#f92672>!</span> {non updatable}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//utxos-org.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class=footer><div class=container><div class=row><div class=col-12><div class=footer-inner><h3 class=footer-title>utxos.org -- Bitcoin for Everyone</h3><ul></ul></div></div></div></div></div><script type=text/javascript src=/js/scripts.min.8504133605a277da18f0d58cfd2e90d154962f4a961543a6e2f0a459a2d05462.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-152627278-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-152627278-1")</script><link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,400i|IBM+Plex+Sans+Condensed:400,400i|IBM+Plex+Sans:100,100i,400,400i,700,700i|IBM+Plex+Serif:400,400i&display=swap" rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js integrity=sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script></body></html>